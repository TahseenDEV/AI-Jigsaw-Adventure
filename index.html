<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Jigsaw Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap');

        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #bc13fe;
            --dark-bg: #0a0a12;
            --panel-bg: rgba(20, 20, 35, 0.95);
        }

        body {
            background-color: var(--dark-bg);
            color: #e0e0e0;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden; /* Prevent scrolling while dragging */
            touch-action: none; /* Crucial for touch dragging */
        }

        h1, h2, .tech-font {
            font-family: 'Orbitron', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-blue);
        }

        .neon-border {
            box-shadow: 0 0 5px var(--neon-blue), inset 0 0 5px var(--neon-blue);
            border: 1px solid var(--neon-blue);
        }
        
        .neon-text {
            text-shadow: 0 0 10px var(--neon-blue);
        }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-primary {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.6);
        }

        .piece-canvas {
            touch-action: none;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--neon-pink);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #game-area {
            position: relative;
            background-image: 
                linear-gradient(rgba(10, 10, 18, 0.95), rgba(10, 10, 18, 0.95)),
                url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTTAgNDBMMDQgMEgwTDQwIDQwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNncmlkKSIvPjwvc3ZnPg==');
        }

        /* Puzzle Snap Animation */
        @keyframes snapFlash {
            0% { filter: brightness(1); }
            50% { filter: brightness(2) drop-shadow(0 0 10px gold); }
            100% { filter: brightness(1); }
        }
        .snapped {
            animation: snapFlash 0.3s ease-out;
        }

        .modal-overlay {
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
        }

        /* Disabled state for difficulty buttons during loading */
        .diff-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        /* Gallery Grid Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .gallery-item {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* --- TOUR STYLES --- */
        #tourOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 100;
            transition: opacity 0.5s;
        }
        
        .highlight-active {
            position: relative;
            z-index: 101 !important;
            box-shadow: 0 0 0 4px var(--neon-blue), 0 0 50px rgba(0, 243, 255, 0.5);
            transition: all 0.3s ease;
            background-color: rgba(20, 20, 35, 0.95); /* Ensure readability */
            border-radius: 8px;
        }

        /* Tooltip Box */
        .tour-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--neon-blue);
            color: white;
            padding: 16px;
            border-radius: 12px;
            width: 280px;
            z-index: 102;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
            font-family: 'Rajdhani', sans-serif;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .tour-tooltip.visible {
            opacity: 1;
        }

        /* Arrow Pointer */
        .tour-arrow {
            position: absolute;
            width: 0; 
            height: 0; 
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid var(--neon-blue);
        }
        /* Bounce Animation for Arrow */
        @keyframes bouncePoint {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-point {
            animation: bouncePoint 1s infinite;
        }

    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar Controls -->
    <aside id="sidebarPanel" class="w-full md:w-80 glass-panel flex flex-col z-20 border-b md:border-b-0 md:border-r border-gray-800 shadow-2xl flex-shrink-0">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 tech-font">
                AI <span class="text-white">JIGSAW</span>
            </h1>
            <p class="text-xs text-gray-400 mt-1">GENERATIVE PUZZLE ENGINE v3.1</p>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6" id="sidebarContent">
            
            <!-- AI Generator Section (Added ID for Tour) -->
            <div id="aiGenSection" class="space-y-3 p-2 -m-2 rounded-lg transition-colors">
                <label class="text-sm font-semibold text-cyan-300 uppercase tracking-wider">
                    <i class="fas fa-microchip mr-2"></i>Generate Image
                </label>
                <div class="relative">
                    <input type="text" id="promptInput" placeholder="Enter idea or leave empty for surprise..." 
                        class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-cyan-400 transition-colors text-white placeholder-gray-500">
                    <button id="randomPromptBtn" class="absolute right-2 top-2.5 text-gray-400 hover:text-white" title="Surprise Me!">
                        <i class="fas fa-dice"></i>
                    </button>
                </div>
                <button id="generateBtn" class="w-full btn-primary text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 group">
                    <i class="fas fa-magic group-hover:rotate-12 transition-transform"></i>
                    GENERATE PUZZLE
                </button>
            </div>

            <!-- Difficulty Settings (Added ID for Tour) -->
            <div id="diffSection" class="space-y-3 p-2 -m-2 rounded-lg transition-colors">
                <label class="text-sm font-semibold text-cyan-300 uppercase tracking-wider">
                    <i class="fas fa-layer-group mr-2"></i>Complexity
                </label>
                <!-- Default selection highlighted -->
                <div class="grid grid-cols-3 gap-2" id="difficultyContainer">
                    <button class="diff-btn bg-gray-800 hover:bg-gray-700 border border-cyan-500 rounded p-2 text-xs transition-all active-diff text-cyan-400" data-rows="3" data-cols="3">EASY<br>(3x3)</button>
                    <button class="diff-btn bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded p-2 text-xs transition-all" data-rows="5" data-cols="5">MED<br>(5x5)</button>
                    <button class="diff-btn bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded p-2 text-xs transition-all" data-rows="8" data-cols="8">HARD<br>(8x8)</button>
                </div>
            </div>

            <!-- Game Stats -->
            <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400 text-sm">Progress</span>
                    <span id="progressText" class="text-cyan-400 font-bold">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="progressBar" class="bg-cyan-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-4 text-xs text-gray-400">
                    <span><i class="fas fa-stopwatch mr-1"></i> <span id="timer">00:00</span></span>
                    <span><i class="fas fa-puzzle-piece mr-1"></i> <span id="piecesCount">0/0</span></span>
                </div>
            </div>

            <!-- My Collection / Gallery Feature (Added ID for Tour) -->
            <div id="collectionSection" class="mt-4 p-4 rounded-lg bg-gray-800/30 border border-gray-700">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">My Collection</h3>
                <button id="openGalleryBtn" class="w-full bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-300 text-xs py-2 rounded border border-cyan-700/50 flex items-center justify-center gap-2 transition-all">
                    <i class="fas fa-images"></i> My Masterpiece Gallery
                </button>
            </div>

            <!-- Monetization Mockup -->
            <div class="mt-4 p-4 rounded-lg bg-gradient-to-br from-purple-900/40 to-blue-900/40 border border-purple-500/30">
                <h3 class="text-xs font-bold text-purple-300 uppercase mb-2">Premium Features</h3>
                <button class="w-full mb-2 bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-200 text-xs py-2 rounded border border-yellow-600/50 flex items-center justify-center gap-2">
                    <i class="fas fa-crown"></i> Unlock Fantasy Pack
                </button>
                <button onclick="toggleHint()" class="w-full bg-blue-600/20 hover:bg-blue-600/40 text-blue-200 text-xs py-2 rounded border border-blue-600/50 flex items-center justify-center gap-2">
                    <i class="fas fa-eye"></i> Show Preview Hint (Ad)
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-gray-700 text-center text-gray-500 text-xs">
            Made By Tahseen With üíù. India 
        </div>
    </aside>

    <!-- Main Game Area -->
    <main class="flex-1 relative flex flex-col h-full">
        <!-- Toolbar for Mobile/Tablet -->
        <div class="md:hidden h-14 glass-panel flex items-center justify-between px-4 z-10">
            <span class="tech-font text-cyan-400 font-bold">AI JIGSAW</span>
            <button id="mobileMenuBtn" class="text-white"><i class="fas fa-bars"></i></button>
        </div>

        <div id="game-area" class="flex-1 relative overflow-hidden flex items-center justify-center">
            
            <!-- Reference Image (Hint) -->
            <div id="hintImageContainer" class="absolute top-4 right-4 w-48 h-32 border-2 border-cyan-500/50 rounded-lg overflow-hidden hidden bg-black shadow-2xl z-0 transition-opacity duration-300 opacity-50 hover:opacity-100 pointer-events-none">
                <img id="hintImage" src="" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-center text-[10px] py-1 text-white">Reference</div>
            </div>

            <!-- Canvas Layer -->
            <canvas id="puzzleCanvas" class="shadow-2xl"></canvas>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center hidden">
                <div class="loader mb-4"></div>
                <h2 class="text-xl font-bold text-white tech-font">GENERATING ART...</h2>
                <p id="loadingText" class="text-gray-400 text-sm mt-2">Synthesizing pixels...</p>
            </div>

            <!-- Start Screen / Empty State (Wrapped button in ID for Tour) -->
            <div id="startScreen" class="absolute inset-0 z-40 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm p-6 text-center">
                <div class="max-w-md">
                    <i class="fas fa-puzzle-piece text-6xl text-cyan-500 mb-6 animate-pulse"></i>
                    <h2 class="text-3xl font-bold text-white mb-2 tech-font">READY TO SOLVE?</h2>
                    <p class="text-gray-300 mb-8">Generate a unique AI artwork or use the daily challenge to start your puzzle adventure.</p>
                    <!-- Wrapper for highlighting specifically the button area if needed, though button itself works -->
                    <button id="startBtn" class="btn-primary text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg">
                        START ADVENTURE
                    </button>
                </div>
            </div>

            <!-- TOUR SYSTEM ELEMENTS -->
            <div id="tourOverlay" class="hidden"></div>
            <!-- Tooltip will be moved dynamically via JS -->
            <div id="tourTooltip" class="tour-tooltip hidden">
                <div id="tourArrow" class="tour-arrow animate-bounce-point"></div>
                <h3 id="tourTitle" class="text-lg font-bold text-cyan-400 mb-2">Title</h3>
                <p id="tourText" class="text-sm text-gray-300 mb-4 leading-relaxed">Description goes here.</p>
                <div class="flex justify-end">
                    <button id="tourActionBtn" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-1.5 rounded text-xs font-bold transition-colors">
                        NEXT
                    </button>
                </div>
            </div>

            <!-- Intro/Welcome Modal (Simplified) -->
            <div id="introModal" class="fixed inset-0 z-[110] flex items-center justify-center modal-overlay hidden">
                <div class="bg-gray-900 border-2 border-cyan-500 p-8 rounded-2xl max-w-sm w-full text-center shadow-[0_0_50px_rgba(0,243,255,0.2)]">
                    <div class="w-20 h-20 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg animate-bounce">
                        <i class="fas fa-hand-spock text-4xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white tech-font mb-4">WELCOME, TRAVELER!</h2>
                    <p class="text-gray-300 text-sm mb-6 leading-relaxed">
                        Welcome to <b>AI Jigsaw Adventure</b>. Get ready to experience infinite puzzles generated by AI. Let's show you around!
                    </p>
                    <button id="startTourBtn" class="w-full btn-primary text-white font-bold py-3 rounded-lg">
                        START TOUR <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                    <button onclick="skipTour()" class="text-xs text-gray-500 hover:text-white mt-4 underline">Skip & Play</button>
                </div>
            </div>

            <!-- Final Ready Modal -->
            <div id="finalTourModal" class="fixed inset-0 z-[110] flex items-center justify-center modal-overlay hidden">
                <div class="bg-gray-900 border-2 border-green-500 p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
                    <i class="fas fa-flag-checkered text-5xl text-green-400 mb-4"></i>
                    <h2 class="text-2xl font-bold text-white tech-font mb-4">YOU'RE READY!</h2>
                    <p class="text-gray-300 text-sm mb-6">
                        The world of infinite puzzles awaits. Go create your masterpiece!
                    </p>
                    <button onclick="endTour()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg">
                        LET'S START
                    </button>
                </div>
            </div>

            <!-- Reset Confirmation Modal -->
            <div id="resetModal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
                <div class="bg-gray-900 border border-red-500 p-8 rounded-2xl max-w-sm w-full text-center shadow-lg">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <h2 class="text-xl font-bold text-white tech-font mb-2">RESET PUZZLE?</h2>
                    <p class="text-gray-400 text-sm mb-6">Are you sure you want to generate a new puzzle? Your current progress will be lost.</p>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button id="cancelResetBtn" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg text-sm">Cancel</button>
                        <button id="confirmResetBtn" class="bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg text-sm font-bold">Yes, Reset</button>
                    </div>
                </div>
            </div>

            <!-- Victory Modal -->
            <div id="victoryModal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
                <div class="bg-gray-900 border border-cyan-500 p-8 rounded-2xl max-w-sm w-full text-center shadow-[0_0_50px_rgba(0,243,255,0.3)] transform scale-95 transition-all">
                    <div class="w-20 h-20 bg-cyan-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-trophy text-4xl text-yellow-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white tech-font mb-2">PUZZLE COMPLETE!</h2>
                    <p class="text-gray-400 text-sm mb-6">Time: <span id="finalTime" class="text-cyan-400">00:00</span></p>
                    <p class="text-green-400 text-xs mb-4 animate-pulse">‚òÖ Saved to Gallery!</p>
                    
                    <!-- View Masterpiece Button -->
                    <button id="viewArtBtn" class="w-full bg-purple-600 hover:bg-purple-500 text-white py-3 rounded-lg text-sm font-bold shadow-lg border border-purple-400 mb-3 flex items-center justify-center gap-2 group">
                        <i class="fas fa-eye group-hover:scale-110 transition-transform"></i> VIEW MASTERPIECE
                    </button>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="closeVictory()" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg text-sm">Close</button>
                        <button id="nextLevelBtn" class="btn-primary text-white py-2 rounded-lg text-sm font-bold">Next AI Art</button>
                    </div>
                    <p class="text-xs text-gray-500">Watch an ad to multiply coins? (Mockup)</p>
                </div>
            </div>

            <!-- Gallery Modal (New Feature) -->
            <div id="galleryModal" class="fixed inset-0 z-[55] flex items-center justify-center modal-overlay hidden">
                <div class="bg-gray-900 border border-cyan-700 w-11/12 max-w-4xl h-5/6 rounded-2xl flex flex-col shadow-2xl overflow-hidden">
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                        <h2 class="text-xl font-bold text-white tech-font"><i class="fas fa-images text-cyan-400 mr-2"></i>MY MASTERPIECE GALLERY</h2>
                        <button id="closeGalleryBtn" class="text-gray-400 hover:text-white transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="galleryGrid" class="flex-1 p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 bg-[#0a0a12]">
                        <!-- Dynamic Content Goes Here -->
                    </div>
                    <div class="p-3 border-t border-gray-700 bg-gray-800 flex justify-between items-center">
                        <span class="text-xs text-gray-500" id="galleryCount">0 Masterpieces</span>
                        <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-300">Clear History</button>
                    </div>
                </div>
            </div>

            <!-- Full Image Modal -->
            <div id="fullImageModal" class="fixed inset-0 z-[60] flex items-center justify-center modal-overlay hidden cursor-pointer" onclick="closeFullImage()">
                <div class="relative max-w-5xl max-h-[90vh] p-4 flex flex-col items-center animate-[zoomIn_0.3s_ease-out]">
                    <img id="fullArtImage" src="" class="max-w-full max-h-[80vh] rounded-lg shadow-[0_0_50px_rgba(0,243,255,0.5)] border-2 border-cyan-500 object-contain bg-black/50">
                    <p class="text-white text-center mt-4 tech-font text-lg animate-pulse">
                        <i class="fas fa-compress-arrows-alt mr-2"></i>TAP ANYWHERE TO CLOSE
                    </p>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- Game Configuration & State ---
        
        // Curated Prompt Library for "Next AI Art" Variety
        const PRESET_PROMPTS = [
            "A majestic fantasy castle on a floating island, digital art",
            "Cute golden retriever puppy playing in autumn leaves, photorealistic",
            "Cyberpunk street food stall at night, neon lights, detailed",
            "Peaceful japanese garden with cherry blossoms and a koi pond",
            "A steampunk owl with brass gears and glowing eyes",
            "majestic floating islands with waterfalls in the sky, fantasy digital art, 8k",
            "ancient elven city in a glowing forest, bioluminescent plants, detailed",
            "dragon resting on a mountain of gold, epic fantasy realism",
            "crystal castle on a snowy peak, magical atmosphere, intricate",
            "mystical library with flying books and glowing runes, hogwarts style",
            "futuristic cyberpunk city street at night, neon rain, blade runner style",
            "cute robot gardening in a spaceship greenhouse, detailed sci-fi",
            "astronaut discovering a glowing alien artifact on mars, cinematic",
            "flying cars traffic in a high tech metropolis, sunset, synthwave",
            "cybernetic tiger prowling in a neon jungle, mechanical details",
            "majestic white tiger in a snowy forest, national geographic style",
            "underwater coral reef with colorful fish and sun rays, 4k",
            "autumn forest path with golden leaves and misty morning light",
            "macro photography of a dew drop on a spider web, sparkling",
            "northern lights aurora borealis over a calm lake, reflection",
            "colorful explosion of paint powder, macro abstract art",
            "surreal melting clocks in a desert, dali style digital art",
            "steampunk mechanical heart with gears and brass pipes, intricate",
            "paper cut craft art of a mountain landscape, layered depth",
            "origami animals in a paper forest, soft lighting, 3d render",
            "fluffy kitten wearing a wizard hat casting a spell, cute digital art",
            "tiny village inside a glass terrarium bottle, magical detail",
            "tea party with rabbits and squirrels in a garden, storybook style",
            "baby dragon sleeping on a treasure chest, adorable",
            "hamster running a tiny coffee shop, detailed illustration"
        ];

        const CONFIG = {
            snapDistance: 20, // pixels
            pollinationsUrl: 'https://image.pollinations.ai/prompt/',
            fallbackUrl: 'https://picsum.photos',
            defaultPrompt: 'mysterious ancient ruins in a jungle, digital art, 8k'
        };

        const STATE = {
            image: null,
            loadingImage: null, 
            pieces: [],
            selectedPiece: null,
            rows: 3,
            cols: 3,
            width: 0,
            height: 0,
            pieceWidth: 0,
            pieceHeight: 0,
            offsetX: 0,
            offsetY: 0,
            isDragging: false,
            startTime: 0,
            timerInterval: null,
            isComplete: false,
            scale: 1,
            zIndexCounter: 10,
            gameInProgress: false,
            currentPrompt: "",
            tourStepIndex: 0
        };

        // --- DOM Elements ---
        const canvas = document.getElementById('puzzleCanvas');
        const ctx = canvas.getContext('2d');
        const promptInput = document.getElementById('promptInput');
        const generateBtn = document.getElementById('generateBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const startScreen = document.getElementById('startScreen');
        const gameArea = document.getElementById('game-area');
        const hintImage = document.getElementById('hintImage');
        const hintContainer = document.getElementById('hintImageContainer');
        const victoryModal = document.getElementById('victoryModal');
        const resetModal = document.getElementById('resetModal');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        const cancelResetBtn = document.getElementById('cancelResetBtn');
        const fullImageModal = document.getElementById('fullImageModal');
        const fullArtImage = document.getElementById('fullArtImage');
        const openGalleryBtn = document.getElementById('openGalleryBtn');
        const galleryModal = document.getElementById('galleryModal');
        const closeGalleryBtn = document.getElementById('closeGalleryBtn');
        const galleryGrid = document.getElementById('galleryGrid');
        
        // --- TOUR ELEMENTS ---
        const introModal = document.getElementById('introModal');
        const tourOverlay = document.getElementById('tourOverlay');
        const tourTooltip = document.getElementById('tourTooltip');
        const tourTitle = document.getElementById('tourTitle');
        const tourText = document.getElementById('tourText');
        const tourActionBtn = document.getElementById('tourActionBtn');
        const tourArrow = document.getElementById('tourArrow');
        const finalTourModal = document.getElementById('finalTourModal');

        // --- Audio Context (Simple Beeps) ---
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioCtx();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'snap') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.6);
            }
        }

        // --- Initialization ---
        window.addEventListener('resize', handleResize);
        
        // CHECK TOUR ON LOAD
        window.addEventListener('DOMContentLoaded', () => {
            const seen = localStorage.getItem('tourSeen');
            if (!seen) {
                // Show Intro Modal
                introModal.classList.remove('hidden');
            }
        });

        // --- TOUR SYSTEM LOGIC ---
        const TOUR_STEPS = [
            {
                targetId: 'startBtn',
                title: 'Quick Play',
                text: 'Just for play not according to your prompt. If you tap this button, the game itself generates a random puzzle for you to solve immediately.',
                position: 'bottom' // Tooltip appears below target
            },
            {
                targetId: 'aiGenSection',
                title: 'Create Your World',
                text: 'Want something specific? Type any idea here (e.g., "Neon City") or roll the dice. Then click Generate!',
                position: 'right'
            },
            {
                targetId: 'diffSection',
                title: 'Choose Challenge',
                text: 'Select your difficulty level. Start with 3x3 for a quick warmup or go 8x8 for a real challenge.',
                position: 'right'
            },
            {
                targetId: 'collectionSection',
                title: 'Your Legacy',
                text: 'Every puzzle you solve is automatically saved here in your Masterpiece Gallery. Build your collection!',
                position: 'top' // Tooltip appears above target (since it's at bottom)
            }
        ];

        document.getElementById('startTourBtn').addEventListener('click', () => {
            introModal.classList.add('hidden');
            tourOverlay.classList.remove('hidden');
            STATE.tourStepIndex = 0;
            showTourStep();
        });

        tourActionBtn.addEventListener('click', () => {
            // Cleanup current highlight
            const currentStep = TOUR_STEPS[STATE.tourStepIndex];
            const el = document.getElementById(currentStep.targetId);
            if(el) el.classList.remove('highlight-active');

            STATE.tourStepIndex++;
            if (STATE.tourStepIndex < TOUR_STEPS.length) {
                showTourStep();
            } else {
                // Tour Ended
                tourTooltip.classList.add('hidden');
                tourTooltip.classList.remove('visible');
                finalTourModal.classList.remove('hidden');
            }
        });

        function showTourStep() {
            const step = TOUR_STEPS[STATE.tourStepIndex];
            const targetEl = document.getElementById(step.targetId);
            
            if (!targetEl) return;

            // 1. Scroll to element if needed
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // 2. Highlight Element
            targetEl.classList.add('highlight-active');

            // 3. Position Tooltip
            const rect = targetEl.getBoundingClientRect();
            
            // Set Text
            tourTitle.innerText = step.title;
            tourText.innerText = step.text;
            tourTooltip.classList.remove('hidden');
            
            // Simple positioning logic
            // Reset positioning
            tourTooltip.style.top = 'auto';
            tourTooltip.style.bottom = 'auto';
            tourTooltip.style.left = 'auto';
            tourTooltip.style.right = 'auto';
            tourArrow.style.top = 'auto';
            tourArrow.style.bottom = 'auto';
            tourArrow.style.left = '50%';
            tourArrow.style.transform = 'translateX(-50%)';
            tourArrow.className = 'tour-arrow animate-bounce-point'; // Reset arrow class

            // Gap
            const gap = 20;

            if (step.position === 'bottom') {
                // Place below
                tourTooltip.style.top = (rect.bottom + gap) + 'px';
                tourTooltip.style.left = (rect.left + rect.width/2 - 140) + 'px'; // Center horizontally (280px width / 2)
                
                // Arrow pointing up
                tourArrow.style.top = '-10px';
                tourArrow.style.borderBottom = '10px solid var(--neon-blue)';
                tourArrow.style.borderTop = 'none';
            } 
            else if (step.position === 'right') {
                // Place to the right (for sidebar items on desktop)
                if (window.innerWidth > 768) {
                    tourTooltip.style.top = (rect.top) + 'px';
                    tourTooltip.style.left = (rect.right + gap) + 'px';
                    
                    // Arrow pointing left
                    tourArrow.style.left = '-10px';
                    tourArrow.style.top = '20px';
                    tourArrow.style.transform = 'none';
                    tourArrow.style.borderRight = '10px solid var(--neon-blue)';
                    tourArrow.style.borderLeft = 'none';
                    tourArrow.style.borderBottom = '10px solid transparent';
                    tourArrow.style.borderTop = '10px solid transparent';
                    // Horizontal bounce
                    tourArrow.style.animationName = 'bouncePointHoriz'; 
                } else {
                    // On Mobile, place below
                    tourTooltip.style.top = (rect.bottom + gap) + 'px';
                    tourTooltip.style.left = (window.innerWidth/2 - 140) + 'px';
                    tourArrow.style.top = '-10px';
                    tourArrow.style.borderBottom = '10px solid var(--neon-blue)';
                    tourArrow.style.borderTop = 'none';
                }
            }
            else if (step.position === 'top') {
                // Place above
                tourTooltip.style.bottom = (window.innerHeight - rect.top + gap) + 'px'; // Calculate from bottom
                tourTooltip.style.left = (window.innerWidth > 768 ? (rect.right + gap) : (window.innerWidth/2 - 140)) + 'px';
                
                if (window.innerWidth > 768) {
                     // Keep sidebar right logic for desktop consistency or move above?
                     // Let's stick to Right side for sidebar items on desktop even for bottom element
                     tourTooltip.style.bottom = 'auto';
                     tourTooltip.style.top = (rect.top - 100) + 'px'; // Move up a bit
                     tourTooltip.style.left = (rect.right + gap) + 'px';
                     
                     tourArrow.style.left = '-10px';
                     tourArrow.style.top = '120px'; // Adjust arrow down relative to box
                     tourArrow.style.transform = 'none';
                     tourArrow.style.borderRight = '10px solid var(--neon-blue)';
                     tourArrow.style.borderLeft = 'none';
                     tourArrow.style.borderBottom = '10px solid transparent';
                     tourArrow.style.borderTop = '10px solid transparent';
                } else {
                    // Mobile: Above
                    tourTooltip.style.bottom = (window.innerHeight - rect.top + gap) + 'px';
                    tourTooltip.style.left = (window.innerWidth/2 - 140) + 'px';
                    
                    // Arrow pointing down
                    tourArrow.style.bottom = '-10px';
                    tourArrow.style.top = 'auto';
                    tourArrow.style.borderTop = '10px solid var(--neon-blue)';
                    tourArrow.style.borderBottom = 'none';
                }
            }

            // Fade In
            setTimeout(() => tourTooltip.classList.add('visible'), 50);
        }

        function skipTour() {
            introModal.classList.add('hidden');
            localStorage.setItem('tourSeen', 'true');
        }

        function endTour() {
            finalTourModal.classList.add('hidden');
            tourOverlay.classList.add('hidden');
            localStorage.setItem('tourSeen', 'true');
        }

        // --- Standard Event Listeners ---

        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Update UI
                document.querySelectorAll('.diff-btn').forEach(b => {
                    b.classList.remove('active-diff', 'border-cyan-500', 'text-cyan-400');
                    b.classList.add('border-gray-600');
                });
                const target = e.currentTarget;
                target.classList.add('active-diff', 'border-cyan-500', 'text-cyan-400');
                target.classList.remove('border-gray-600');
                
                // Update State
                STATE.rows = parseInt(target.dataset.rows);
                STATE.cols = parseInt(target.dataset.cols);
            });
        });

        // FIXED: Start Button Logic
        document.getElementById('startBtn').addEventListener('click', () => {
            // Prevent click if tour is active (overlay prevents it mostly, but just in case)
            if(!tourOverlay.classList.contains('hidden')) return;

            startScreen.classList.add('hidden');
            
            // Check if a game is already prepared
            if (STATE.gameInProgress && STATE.pieces.length > 0) {
                 startTimer();
                 return;
            }

            processGeneration(true); 
        });

        // Generate Button Handler
        generateBtn.addEventListener('click', () => {
            if (STATE.gameInProgress && !STATE.isComplete) {
                // Show Confirmation
                resetModal.classList.remove('hidden');
                resetModal.classList.add('flex');
            } else {
                // If input is empty, pick random, else use input
                const useRandom = promptInput.value.trim() === "";
                processGeneration(useRandom);
            }
        });

        // Modal Handlers
        confirmResetBtn.addEventListener('click', () => {
            resetModal.classList.add('hidden');
            resetModal.classList.remove('flex');
            
            const useRandom = promptInput.value.trim() === "";
            processGeneration(useRandom);
        });

        cancelResetBtn.addEventListener('click', () => {
            resetModal.classList.add('hidden');
            resetModal.classList.remove('flex');
        });

        // Next Level Button - ALWAYS forces a new random prompt
        document.getElementById('nextLevelBtn').addEventListener('click', () => {
            closeVictory();
            processGeneration(true); // true = Force random prompt
        });

        // View Masterpiece Button Logic
        document.getElementById('viewArtBtn').addEventListener('click', () => {
            if (STATE.image) {
                fullArtImage.src = STATE.image.src;
                fullImageModal.classList.remove('hidden');
            }
        });

        // Gallery Modal Logic
        openGalleryBtn.addEventListener('click', () => {
            renderGallery();
            galleryModal.classList.remove('hidden');
        });

        closeGalleryBtn.addEventListener('click', () => {
            galleryModal.classList.add('hidden');
        });

        function closeFullImage() {
            fullImageModal.classList.add('hidden');
        }

        document.getElementById('randomPromptBtn').addEventListener('click', () => {
            const randomPrompt = PRESET_PROMPTS[Math.floor(Math.random() * PRESET_PROMPTS.length)];
            promptInput.value = randomPrompt;
        });

        // --- Toggle Controls Helper ---
        function toggleControls(disable) {
            const btns = document.querySelectorAll('.diff-btn');
            btns.forEach(btn => {
                btn.disabled = disable;
            });
            // Also optional: disable generate button to prevent spamming
            generateBtn.disabled = disable;
            if(disable) {
                generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- Gallery / History Functions (Local Storage) ---

        function addToHistory(imageUrl, prompt) {
            let history = JSON.parse(localStorage.getItem('puzzleHistory') || '[]');
            
            // Avoid duplicates (by URL)
            const exists = history.some(item => item.url === imageUrl);
            if(exists) return;

            const entry = {
                url: imageUrl,
                prompt: prompt,
                date: new Date().toLocaleString(),
                timestamp: Date.now()
            };

            // Add to beginning
            history.unshift(entry);

            // Limit storage to last 50 items to be safe
            if(history.length > 50) history.pop();

            localStorage.setItem('puzzleHistory', JSON.stringify(history));
            updateGalleryCount();
        }

        function renderGallery() {
            const history = JSON.parse(localStorage.getItem('puzzleHistory') || '[]');
            galleryGrid.innerHTML = '';

            if(history.length === 0) {
                galleryGrid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center text-gray-500 h-64">
                        <i class="fas fa-ghost text-4xl mb-3 opacity-50"></i>
                        <p>No masterpieces yet.</p>
                        <p class="text-xs mt-1">Solve a puzzle to save it here!</p>
                    </div>
                `;
                return;
            }

            history.forEach(item => {
                const el = document.createElement('div');
                el.className = 'gallery-item bg-gray-800 rounded-lg overflow-hidden border border-gray-700 hover:border-cyan-500 transition-all cursor-pointer group';
                el.onclick = () => {
                    fullArtImage.src = item.url;
                    fullImageModal.classList.remove('hidden');
                };

                el.innerHTML = `
                    <div class="relative h-32 overflow-hidden">
                        <img src="${item.url}" class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                    </div>
                    <div class="p-2">
                        <p class="text-xs text-gray-300 truncate" title="${item.prompt}">${item.prompt}</p>
                        <p class="text-[10px] text-gray-500 mt-1">${item.date}</p>
                    </div>
                `;
                galleryGrid.appendChild(el);
            });
            updateGalleryCount();
        }

        function updateGalleryCount() {
            const history = JSON.parse(localStorage.getItem('puzzleHistory') || '[]');
            document.getElementById('galleryCount').innerText = `${history.length} Masterpieces`;
        }

        function clearHistory() {
            if(confirm('Are you sure you want to delete all saved masterpieces?')) {
                localStorage.removeItem('puzzleHistory');
                renderGallery();
            }
        }

        // --- Core Functions ---

        async function processGeneration(useRandom = false, skipConfirmation = false) {
            // 0. Disable Controls
            toggleControls(true);

            // 1. Reset Game State Cleanly
            stopTimer();
            STATE.pieces = [];
            STATE.gameInProgress = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear immediately
            
            // 2. Abort previous image load if it's still stuck
            if (STATE.loadingImage) {
                console.log("Cancelling previous pending image request.");
                STATE.loadingImage.onload = null;
                STATE.loadingImage.onerror = null;
                STATE.loadingImage.src = ""; // This cancels the download in most browsers
                STATE.loadingImage = null;
            }
            
            // 3. Determine Prompt
            let prompt;
            if (useRandom) {
                // Pick a fresh random prompt from our library
                prompt = PRESET_PROMPTS[Math.floor(Math.random() * PRESET_PROMPTS.length)];
                promptInput.value = prompt; // Show user what was picked
            } else {
                prompt = promptInput.value.trim() || CONFIG.defaultPrompt;
            }

            // Save prompt to state for history
            STATE.currentPrompt = prompt;

            // 4. Show Loader
            loadingOverlay.classList.remove('hidden');
            STATE.isComplete = false;
            
            const safePrompt = encodeURIComponent(prompt);
            // Use Date.now() to absolutely force a fresh non-cached request
            const seed = Date.now(); 
            
            // Using Pollinations for AI generation
            const imageUrl = `${CONFIG.pollinationsUrl}${safePrompt}?width=1024&height=768&seed=${seed}&nologo=true&t=${seed}`;
            
            loadingText.innerText = `Synthesizing: "${prompt.substring(0, 30)}..."`;

            try {
                // 5. Load Image with Cancellation Tracking
                const img = new Image();
                img.crossOrigin = "Anonymous"; 
                
                // Track this specific image request
                STATE.loadingImage = img;
                
                img.onload = () => {
                    // Only proceed if this is still the active request
                    if (STATE.loadingImage === img) {
                        STATE.image = img;
                        hintImage.src = img.src;
                        initGame();
                        loadingOverlay.classList.add('hidden');
                        
                        // Show "Ready to Solve?" screen as a confirmation step (as requested)
                        if (!skipConfirmation) {
                            startScreen.classList.remove('hidden');
                            // Timer will start when user clicks "Start Adventure"
                        } else {
                            startTimer();
                        }
                        
                        STATE.loadingImage = null; // Clear the tracker
                        
                        // Re-enable controls
                        toggleControls(false);
                    }
                };

                img.onerror = () => {
                    if (STATE.loadingImage === img) {
                        console.warn("AI Gen failed, falling back to Picsum");
                        loadingText.innerText = "AI Busy. Fetching backup feed...";
                        // Retry with backup
                        const backupImg = new Image();
                        backupImg.crossOrigin = "Anonymous";
                        backupImg.onload = () => {
                             if (STATE.loadingImage === backupImg) {
                                STATE.image = backupImg;
                                hintImage.src = backupImg.src;
                                initGame();
                                loadingOverlay.classList.add('hidden');
                                if (!skipConfirmation) {
                                    startScreen.classList.remove('hidden');
                                } else {
                                    startTimer();
                                }
                                STATE.loadingImage = null;
                                toggleControls(false);
                             }
                        };
                        backupImg.onerror = () => {
                            toggleControls(false); // Enable even on full fail
                        };
                        backupImg.src = `${CONFIG.fallbackUrl}/1024/768?random=${seed}`;
                        STATE.loadingImage = backupImg; // Update tracker to backup
                    }
                };

                img.src = imageUrl;

            } catch (error) {
                console.error(error);
                loadingOverlay.classList.add('hidden');
                alert("Failed to load image. Please try again.");
                STATE.loadingImage = null;
                toggleControls(false);
            }
        }

        function initGame() {
            // Calculate Dimensions
            const containerW = gameArea.clientWidth;
            const containerH = gameArea.clientHeight;
            
            // Scale image to fit container with padding
            const padding = 40;
            const availW = containerW - padding * 2;
            const availH = containerH - padding * 2;
            
            const imgRatio = STATE.image.width / STATE.image.height;
            const containerRatio = availW / availH;

            if (imgRatio > containerRatio) {
                STATE.width = availW;
                STATE.height = availW / imgRatio;
            } else {
                STATE.height = availH;
                STATE.width = availH * imgRatio;
            }

            STATE.offsetX = (containerW - STATE.width) / 2;
            STATE.offsetY = (containerH - STATE.height) / 2;

            canvas.width = containerW;
            canvas.height = containerH;
            
            STATE.pieceWidth = STATE.width / STATE.cols;
            STATE.pieceHeight = STATE.height / STATE.rows;

            STATE.gameInProgress = true;
            createPieces();
            shufflePieces();
            draw();
            updateStats();
        }

        // --- Jigsaw Logic ---

        class Piece {
            constructor(r, c) {
                this.r = r;
                this.c = c;
                // Target position (solved)
                this.tx = STATE.offsetX + c * STATE.pieceWidth;
                this.ty = STATE.offsetY + r * STATE.pieceHeight;
                // Current position
                this.x = 0; 
                this.y = 0;
                this.isLocked = false;
                this.zIndex = 0;
                
                // Tabs: 1 = out, -1 = in, 0 = flat (edge)
                this.top = 0;
                this.right = 0;
                this.bottom = 0;
                this.left = 0;
            }
        }

        function createPieces() {
            STATE.pieces = [];
            for (let r = 0; r < STATE.rows; r++) {
                for (let c = 0; c < STATE.cols; c++) {
                    let p = new Piece(r, c);
                    
                    if (r > 0) p.top = -STATE.pieces[(r-1)*STATE.cols + c].bottom;
                    if (r < STATE.rows - 1) p.bottom = Math.random() > 0.5 ? 1 : -1;
                    
                    if (c > 0) p.left = -STATE.pieces[STATE.pieces.length - 1].right;
                    if (c < STATE.cols - 1) p.right = Math.random() > 0.5 ? 1 : -1;

                    STATE.pieces.push(p);
                }
            }
        }

        function shufflePieces() {
            STATE.pieces.forEach(p => {
                // Random position within canvas bounds
                p.x = Math.random() * (canvas.width - STATE.pieceWidth);
                p.y = Math.random() * (canvas.height - STATE.pieceHeight);
                p.isLocked = false;
                p.zIndex = Math.floor(Math.random() * 10);
            });
        }

        // Draw a single jigsaw path
        function drawPiecePath(ctx, piece, width, height) {
            const x = 0; 
            const y = 0;
            // Refined size for cleaner tabs
            const tabSize = Math.min(width, height) * 0.22; 
            
            ctx.beginPath();
            ctx.moveTo(x, y);

            // Top
            if (piece.top !== 0) {
                drawTab(ctx, x, y, x + width, y, piece.top, tabSize);
            } else {
                ctx.lineTo(x + width, y);
            }

            // Right
            if (piece.right !== 0) {
                drawTab(ctx, x + width, y, x + width, y + height, piece.right, tabSize);
            } else {
                ctx.lineTo(x + width, y + height);
            }

            // Bottom
            if (piece.bottom !== 0) {
                drawTab(ctx, x + width, y + height, x, y + height, piece.bottom, tabSize);
            } else {
                ctx.lineTo(x, y + height);
            }

            // Left
            if (piece.left !== 0) {
                drawTab(ctx, x, y + height, x, y, piece.left, tabSize);
            } else {
                ctx.lineTo(x, y);
            }

            ctx.closePath();
        }

        // Improved Bezier Curve for Jigsaw Tab (Standard Shape)
        function drawTab(ctx, x1, y1, x2, y2, direction, size) {
            const angle = Math.atan2(y2 - y1, x2 - x1);
            const dist = Math.hypot(x2 - x1, y2 - y1);
            
            ctx.save();
            ctx.translate(x1, y1);
            ctx.rotate(angle);
            
            // Fixed local coordinates
            const cx = dist / 2;
            const neck = size * 0.35; 
            const head = size * 0.8;
            const height = size * direction * 1.2; 
            
            const shoulder = (dist - neck) / 2;

            // Start from 0,0 (which is x1,y1 in global)
            ctx.lineTo(shoulder, 0);
            
            // Bezier 1: Left side of neck/head
            ctx.bezierCurveTo(
                shoulder + neck * 0.2, 0,           // CP1: Stay on line a bit
                shoulder - neck * 0.1, height * 0.6, // CP2: Curve out/in for neck
                cx - head/2, height * 0.6           // End: Widest part of head left
            ); 
            
            // Bezier 2: Top of head
            ctx.bezierCurveTo(
                cx - head * 0.8, height * 1.3,      // CP1: Round top left
                cx + head * 0.8, height * 1.3,      // CP2: Round top right
                cx + head/2, height * 0.6           // End: Widest part of head right
            );

            // Bezier 3: Right side of neck/head
            ctx.bezierCurveTo(
                dist - shoulder + neck * 0.1, height * 0.6, // CP1
                dist - shoulder - neck * 0.2, 0,            // CP2
                dist - shoulder, 0                          // End: Back to line
            );
            
            ctx.lineTo(dist, 0);

            ctx.restore();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw "Ghost" grid (optional visual aid)
            ctx.strokeStyle = "rgba(255, 255, 255, 0.05)";
            ctx.lineWidth = 1;
            ctx.strokeRect(STATE.offsetX, STATE.offsetY, STATE.width, STATE.height);

            // Sort pieces by zIndex so dragged one is on top
            STATE.pieces.sort((a, b) => {
                if(a.isLocked) return -1; // Locked pieces at bottom
                if(b.isLocked) return 1;
                return a.zIndex - b.zIndex;
            });

            STATE.pieces.forEach(p => {
                // 1. Draw Image with Clip
                ctx.save();
                ctx.translate(p.x, p.y);
                drawPiecePath(ctx, p, STATE.pieceWidth, STATE.pieceHeight);
                ctx.clip();

                // Draw specific slice of the image
                ctx.drawImage(
                    STATE.image, 
                    -p.c * STATE.pieceWidth, 
                    -p.r * STATE.pieceHeight, 
                    STATE.width, 
                    STATE.height
                );
                ctx.restore();

                // 2. Draw Bevel/Border for 3D effect
                ctx.save();
                ctx.translate(p.x, p.y);
                drawPiecePath(ctx, p, STATE.pieceWidth, STATE.pieceHeight);
                
                ctx.lineWidth = 1.5;
                if (p === STATE.selectedPiece) {
                    ctx.strokeStyle = "#00f3ff";
                    ctx.shadowColor = "#00f3ff";
                    ctx.shadowBlur = 15;
                    ctx.globalAlpha = 1.0;
                } else if (p.isLocked) {
                    ctx.strokeStyle = "rgba(0,0,0,0.3)";
                    ctx.globalAlpha = 0.8;
                } else {
                    ctx.strokeStyle = "rgba(255,255,255,0.4)";
                    // Add subtle drop shadow for floating pieces
                    ctx.shadowColor = "rgba(0,0,0,0.5)";
                    ctx.shadowBlur = 5;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;
                }
                
                ctx.stroke();
                
                // Inner highlight for depth
                if (!p.isLocked) {
                    ctx.clip();
                    ctx.strokeStyle = "rgba(255,255,255,0.2)";
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                ctx.restore();
            });
        }

        // --- Interaction Handling ---

        function handleStart(x, y) {
            if (STATE.isComplete) return;

            // Find clicked piece (reverse order to get top one first)
            for (let i = STATE.pieces.length - 1; i >= 0; i--) {
                const p = STATE.pieces[i];
                if (p.isLocked) continue;

                if (x >= p.x && x <= p.x + STATE.pieceWidth &&
                    y >= p.y && y <= p.y + STATE.pieceHeight) {
                    
                    // Improved Hit Test using Point in Path for better accuracy with tabs
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    drawPiecePath(ctx, p, STATE.pieceWidth, STATE.pieceHeight);
                    const isHit = ctx.isPointInPath(x, y); // Local check needs adjustment
                    // Actually standard box check is usually better for UX on small screens
                    // Stick to box check but slightly expanded for tabs
                    ctx.restore();

                    // Box check (keep it simple for performance)
                    STATE.selectedPiece = p;
                    STATE.dragOffsetX = x - p.x;
                    STATE.dragOffsetY = y - p.y;
                    STATE.isDragging = true;
                    p.zIndex = ++STATE.zIndexCounter;
                    
                    draw();
                    return;
                }
            }
        }

        function handleMove(x, y) {
            if (!STATE.isDragging || !STATE.selectedPiece) return;

            STATE.selectedPiece.x = x - STATE.dragOffsetX;
            STATE.selectedPiece.y = y - STATE.dragOffsetY;
            draw();
        }

        function handleEnd() {
            if (!STATE.isDragging || !STATE.selectedPiece) return;

            const p = STATE.selectedPiece;
            const dist = Math.hypot(p.x - p.tx, p.y - p.ty);

            if (dist < CONFIG.snapDistance) {
                // Snap!
                p.x = p.tx;
                p.y = p.ty;
                p.isLocked = true;
                p.zIndex = -1; // Send to back
                playSound('snap');
                checkWin();
            }

            STATE.isDragging = false;
            STATE.selectedPiece = null;
            draw();
            updateStats();
        }

        // Event Listeners (Mouse & Touch)
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            handleStart(e.clientX - rect.left, e.clientY - rect.top);
        });
        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            handleMove(e.clientX - rect.left, e.clientY - rect.top);
        });
        window.addEventListener('mouseup', handleEnd);

        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            handleStart(touch.clientX - rect.left, touch.clientY - rect.top);
        }, {passive: false});
        
        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            handleMove(touch.clientX - rect.left, touch.clientY - rect.top);
        }, {passive: false});
        window.addEventListener('touchend', handleEnd);

        // --- Stats & Win Condition ---

        function updateStats() {
            const lockedCount = STATE.pieces.filter(p => p.isLocked).length;
            const total = STATE.pieces.length;
            const percentage = Math.floor((lockedCount / total) * 100);

            document.getElementById('piecesCount').innerText = `${lockedCount}/${total}`;
            document.getElementById('progressText').innerText = `${percentage}%`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
        }

        function checkWin() {
            if (STATE.pieces.every(p => p.isLocked)) {
                STATE.isComplete = true;
                STATE.gameInProgress = false;
                stopTimer();
                playSound('win');
                document.getElementById('finalTime').innerText = document.getElementById('timer').innerText;
                
                // SAVE TO GALLERY HERE
                addToHistory(STATE.image.src, STATE.currentPrompt || "Mystery Puzzle");

                setTimeout(() => {
                    victoryModal.classList.remove('hidden');
                    victoryModal.classList.add('flex');
                }, 500);
            }
        }

        function startTimer() {
            stopTimer();
            STATE.startTime = Date.now();
            STATE.timerInterval = setInterval(() => {
                const delta = Math.floor((Date.now() - STATE.startTime) / 1000);
                const m = Math.floor(delta / 60).toString().padStart(2, '0');
                const s = (delta % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        function stopTimer() {
            if (STATE.timerInterval) clearInterval(STATE.timerInterval);
        }

        function handleResize() {
            if (STATE.image && STATE.pieces.length > 0) initGame();
        }

        // --- Helpers ---
        function toggleHint() {
            hintContainer.classList.toggle('hidden');
        }

        function closeVictory() {
            victoryModal.classList.add('hidden');
            victoryModal.classList.remove('flex');
        }

        // Mobile Menu Toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            const sidebar = document.querySelector('aside');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('inset-0');
            sidebar.classList.toggle('z-50');
        });

    </script>
</body>
</html>
